<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1100" height="1800" viewBox="0 0 1100 1800">
  <style>
    .title { font: bold 20px sans-serif; fill: #333; }
    .subtitle { font: bold 16px sans-serif; fill: #333; }
    .box { fill: #f8f9fa; stroke: #495057; stroke-width: 2; rx: 5; ry: 5; }
    .api { fill: #e6ffe6; stroke: #006600; stroke-width: 2; rx: 5; ry: 5; }
    .analysis { fill: #ffe6e6; stroke: #990000; stroke-width: 2; rx: 5; ry: 5; }
    .broker { fill: #e6f3ff; stroke: #0066cc; stroke-width: 2; rx: 5; ry: 5; }
    .database { fill: #fff0e6; stroke: #cc6600; stroke-width: 2; rx: 5; ry: 5; }
    .healthcheck { fill: #f2e6ff; stroke: #6600cc; stroke-width: 2; rx: 5; ry: 5; }
    .event { fill: #ffffcc; stroke: #cccc00; stroke-width: 2; rx: 15; ry: 15; }
    .process { fill: #ffffff; stroke: #333333; stroke-width: 2; rx: 5; ry: 5; }
    .decision { fill: #ffffff; stroke: #333333; stroke-width: 2; }
    .arrow { stroke: #666; stroke-width: 2; marker-end: url(#arrowhead); fill: none; }
    .arrow-bold { stroke: #333; stroke-width: 3; marker-end: url(#arrowhead-bold); fill: none; }
    .topic { font: italic 12px sans-serif; fill: #6c757d; }
    .step { font: bold 14px sans-serif; fill: white; }
    .step-circle { fill: #333; stroke: none; }
    .note { font: 12px sans-serif; fill: #666; }
    text { font: 14px sans-serif; fill: #333; }
    .section-title { font: bold 18px sans-serif; fill: #333; }
  </style>
  
  <!-- 定义箭头标记 -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
    </marker>
    <marker id="arrowhead-bold" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
  </defs>
  
  <!-- 标题 -->
  <text x="550" y="30" class="title" text-anchor="middle">API服务MQTT模式下任务生命周期管理流程</text>
  
  <!-- 服务启动部分 -->
  <text x="550" y="70" class="section-title" text-anchor="middle">服务启动阶段</text>
  
  <!-- API服务 -->
  <rect x="50" y="100" width="250" height="150" class="api" />
  <text x="175" y="120" class="subtitle" text-anchor="middle">API服务启动</text>
  
  <!-- 启动流程 -->
  <rect x="70" y="140" width="210" height="30" class="process" />
  <text x="175" y="160" text-anchor="middle">初始化数据库</text>
  
  <rect x="70" y="180" width="210" height="30" class="process" />
  <text x="175" y="200" text-anchor="middle">创建AnalysisClient</text>
  
  <!-- MQTT Broker -->
  <rect x="400" y="100" width="150" height="150" class="broker" />
  <text x="475" y="120" class="subtitle" text-anchor="middle">MQTT Broker</text>
  
  <!-- 数据库 -->
  <rect x="650" y="100" width="150" height="150" class="database" />
  <text x="725" y="120" class="subtitle" text-anchor="middle">数据库</text>
  
  <!-- 健康检查器 -->
  <rect x="850" y="100" width="200" height="150" class="healthcheck" />
  <text x="950" y="120" class="subtitle" text-anchor="middle">节点健康检查器</text>
  
  <!-- 箭头连接 -->
  <path d="M175 210 L175 250 L475 250 L475 260" class="arrow" />
  <text x="250" y="240" class="note">1. 连接MQTT Broker</text>
  <text x="250" y="260" class="topic">mqtt_client.connect()</text>
  
  <path d="M475 270 L475 300 L725 300 L725 260" class="arrow" />
  <text x="550" y="290" class="note">2. 订阅主题</text>
  <text x="550" y="310" class="topic">client.subscribe(topics)</text>
  
  <path d="M290 170 L850 170" class="arrow" />
  <text x="400" y="160" class="note">3. 初始化健康检查服务</text>
  <text x="400" y="180" class="topic">start_health_checker()</text>
  
  <path d="M950 170 L950 210 L725 210" class="arrow" />
  <text x="830" y="200" class="note">4. 执行首次健康检查</text>
  <text x="830" y="220" class="topic">check_mqtt_nodes_health()</text>
  
  <!-- 任务创建部分 -->
  <text x="550" y="360" class="section-title" text-anchor="middle">任务创建阶段</text>
  
  <!-- API服务 - 创建任务 -->
  <rect x="50" y="390" width="250" height="380" class="api" />
  <text x="175" y="410" class="subtitle" text-anchor="middle">API服务 - 创建任务</text>
  
  <!-- 创建流程 -->
  <rect x="70" y="430" width="210" height="30" class="process" />
  <text x="175" y="450" text-anchor="middle">接收分析请求(analyze_*)</text>
  
  <rect x="70" y="470" width="210" height="30" class="process" />
  <text x="175" y="490" text-anchor="middle">在数据库创建任务记录</text>
  
  <path d="M290 480 L650 480" class="arrow" />
  
  <rect x="70" y="510" width="210" height="30" class="process" />
  <text x="175" y="530" text-anchor="middle">获取可用MQTT节点</text>
  
  <path d="M175 540 L175 560 L650 560 L650 520" class="arrow" />
  <text x="300" y="550" class="note">mqtt_client.get_available_mqtt_node()</text>
  
  <rect x="70" y="580" width="210" height="30" class="process" />
  <text x="175" y="600" text-anchor="middle">构建任务配置</text>
  
  <rect x="70" y="620" width="210" height="30" class="process" />
  <text x="175" y="640" text-anchor="middle">创建子任务记录</text>
  
  <path d="M290 630 L650 630" class="arrow" />
  
  <rect x="70" y="660" width="210" height="30" class="process" />
  <text x="175" y="680" text-anchor="middle">发送任务消息到节点</text>
  
  <path d="M290 680 L400 680" class="arrow" />
  <text x="290" y="670" class="topic">mqtt_client.send_task_to_node()</text>
  
  <rect x="70" y="700" width="210" height="30" class="process" />
  <text x="175" y="720" text-anchor="middle">更新子任务状态为运行中</text>
  
  <path d="M290 710 L650 710" class="arrow" />
  
  <!-- MQTT Broker -->
  <rect x="400" y="390" width="150" height="380" class="broker" />
  <text x="475" y="410" class="subtitle" text-anchor="middle">MQTT Broker</text>
  
  <!-- MQTT发布/接收 -->
  <rect x="420" y="660" width="110" height="60" class="process" />
  <text x="475" y="680" text-anchor="middle">转发任务</text>
  <text x="475" y="700" class="topic" text-anchor="middle">meek/{mac}/request</text>
  
  <!-- 数据库 -->
  <rect x="650" y="390" width="150" height="380" class="database" />
  <text x="725" y="410" class="subtitle" text-anchor="middle">数据库</text>
  
  <rect x="670" y="470" width="110" height="30" class="process" />
  <text x="725" y="490" text-anchor="middle">存储任务记录</text>
  
  <rect x="670" y="560" width="110" height="30" class="process" />
  <text x="725" y="580" text-anchor="middle">查询可用节点</text>
  
  <rect x="670" y="620" width="110" height="30" class="process" />
  <text x="725" y="640" text-anchor="middle">存储子任务</text>
  
  <rect x="670" y="700" width="110" height="30" class="process" />
  <text x="725" y="720" text-anchor="middle">更新状态为1</text>
  
  <!-- 分析服务 -->
  <rect x="850" y="390" width="200" height="380" class="analysis" />
  <text x="950" y="410" class="subtitle" text-anchor="middle">分析服务节点</text>
  
  <path d="M475 720 L850 720" class="arrow" />
  <text x="600" y="710" class="note">5. 节点接收任务</text>
  
  <rect x="870" y="660" width="160" height="30" class="process" />
  <text x="950" y="680" text-anchor="middle">接收任务请求</text>
  
  <rect x="870" y="700" width="160" height="30" class="process" />
  <text x="950" y="720" text-anchor="middle">返回确认消息</text>
  
  <path d="M870 720 L475 780 L475 750" class="arrow" />
  <text x="600" y="770" class="topic">meek/node_config_reply</text>
  
  <!-- 任务确认与状态更新部分 -->
  <text x="550" y="810" class="section-title" text-anchor="middle">任务确认与状态更新阶段</text>
  
  <!-- API服务 - 任务确认 -->
  <rect x="50" y="840" width="250" height="300" class="api" />
  <text x="175" y="860" class="subtitle" text-anchor="middle">API服务 - 任务确认与更新</text>
  
  <rect x="70" y="890" width="210" height="30" class="process" />
  <text x="175" y="910" text-anchor="middle">接收确认消息</text>
  
  <rect x="70" y="930" width="210" height="30" class="process" />
  <text x="175" y="950" text-anchor="middle">_handle_config_reply()</text>
  
  <rect x="70" y="970" width="210" height="30" class="process" />
  <text x="175" y="990" text-anchor="middle">更新子任务状态</text>
  
  <path d="M290 980 L650 980" class="arrow" />
  
  <rect x="70" y="1010" width="210" height="30" class="process" />
  <text x="175" y="1030" text-anchor="middle">接收任务结果消息</text>
  
  <rect x="70" y="1050" width="210" height="50" class="process" />
  <text x="175" y="1070" text-anchor="middle">_handle_task_result()</text>
  <text x="175" y="1090" text-anchor="middle">更新任务状态和结果</text>
  
  <path d="M290 1070 L650 1070" class="arrow" />
  
  <!-- MQTT Broker -->
  <rect x="400" y="840" width="150" height="300" class="broker" />
  <text x="475" y="860" class="subtitle" text-anchor="middle">MQTT Broker</text>
  
  <path d="M400 900 L290 900" class="arrow" />
  <text x="350" y="890" class="topic">config_reply</text>
  
  <path d="M400 1020 L290 1020" class="arrow" />
  <text x="350" y="1010" class="topic">result</text>
  
  <!-- 数据库 -->
  <rect x="650" y="840" width="150" height="300" class="database" />
  <text x="725" y="860" class="subtitle" text-anchor="middle">数据库</text>
  
  <rect x="670" y="970" width="110" height="30" class="process" />
  <text x="725" y="990" text-anchor="middle">更新子任务状态</text>
  
  <rect x="670" y="1060" width="110" height="30" class="process" />
  <text x="725" y="1080" text-anchor="middle">更新任务结果</text>
  
  <!-- 分析服务 -->
  <rect x="850" y="840" width="200" height="300" class="analysis" />
  <text x="950" y="860" class="subtitle" text-anchor="middle">分析服务节点</text>
  
  <path d="M870 900 L550 900" class="arrow" />
  <text x="700" y="890" class="note">6. 返回确认消息</text>
  
  <rect x="870" y="890" width="160" height="30" class="process" />
  <text x="950" y="910" text-anchor="middle">发送确认消息</text>
  
  <rect x="870" y="930" width="160" height="30" class="process" />
  <text x="950" y="950" text-anchor="middle">执行分析任务</text>
  
  <rect x="870" y="970" width="160" height="30" class="process" />
  <text x="950" y="990" text-anchor="middle">任务处理中</text>
  
  <rect x="870" y="1010" width="160" height="50" class="process" />
  <text x="950" y="1030" text-anchor="middle">完成任务,</text>
  <text x="950" y="1050" text-anchor="middle">发送结果</text>
  
  <path d="M870 1030 L550 1030" class="arrow" />
  <text x="700" y="1020" class="note">7. 返回分析结果</text>
  
  <!-- 任务停止部分 -->
  <text x="550" y="1180" class="section-title" text-anchor="middle">任务停止阶段</text>
  
  <!-- API服务 - 停止任务 -->
  <rect x="50" y="1210" width="250" height="220" class="api" />
  <text x="175" y="1230" class="subtitle" text-anchor="middle">API服务 - 停止任务</text>
  
  <rect x="70" y="1260" width="210" height="30" class="process" />
  <text x="175" y="1280" text-anchor="middle">接收停止请求</text>
  
  <rect x="70" y="1300" width="210" height="30" class="process" />
  <text x="175" y="1320" text-anchor="middle">查找运行中的子任务</text>
  
  <path d="M290 1310 L650 1310" class="arrow" />
  
  <rect x="70" y="1340" width="210" height="30" class="process" />
  <text x="175" y="1360" text-anchor="middle">发送停止命令</text>
  
  <path d="M290 1350 L400 1350" class="arrow" />
  <text x="340" y="1340" class="topic">stop_task</text>
  
  <rect x="70" y="1380" width="210" height="30" class="process" />
  <text x="175" y="1400" text-anchor="middle">更新子任务状态为已停止</text>
  
  <path d="M290 1390 L650 1390" class="arrow" />
  
  <!-- MQTT Broker -->
  <rect x="400" y="1210" width="150" height="220" class="broker" />
  <text x="475" y="1230" class="subtitle" text-anchor="middle">MQTT Broker</text>
  
  <rect x="420" y="1340" width="110" height="30" class="process" />
  <text x="475" y="1360" text-anchor="middle">转发停止命令</text>
  
  <!-- 数据库 -->
  <rect x="650" y="1210" width="150" height="220" class="database" />
  <text x="725" y="1230" class="subtitle" text-anchor="middle">数据库</text>
  
  <rect x="670" y="1300" width="110" height="30" class="process" />
  <text x="725" y="1320" text-anchor="middle">查询子任务</text>
  
  <rect x="670" y="1380" width="110" height="30" class="process" />
  <text x="725" y="1400" text-anchor="middle">更新状态为2</text>
  
  <!-- 分析服务 -->
  <rect x="850" y="1210" width="200" height="220" class="analysis" />
  <text x="950" y="1230" class="subtitle" text-anchor="middle">分析服务节点</text>
  
  <path d="M475 1360 L850 1360" class="arrow" />
  <text x="600" y="1350" class="note">8. 接收停止命令</text>
  
  <rect x="870" y="1340" width="160" height="30" class="process" />
  <text x="950" y="1360" text-anchor="middle">停止任务处理</text>
  
  <rect x="870" y="1380" width="160" height="30" class="process" />
  <text x="950" y="1400" text-anchor="middle">返回确认消息</text>
  
  <path d="M870 1400 L550 1400" class="arrow" />
  
  <!-- 健康检查与任务迁移部分 -->
  <text x="550" y="1470" class="section-title" text-anchor="middle">健康检查与任务迁移阶段</text>
  
  <!-- 健康检查服务 -->
  <rect x="50" y="1500" width="250" height="270" class="healthcheck" />
  <text x="175" y="1520" class="subtitle" text-anchor="middle">节点健康检查服务</text>
  
  <rect x="70" y="1550" width="210" height="30" class="process" />
  <text x="175" y="1570" text-anchor="middle">定期执行健康检查</text>
  
  <rect x="70" y="1590" width="210" height="30" class="process" />
  <text x="175" y="1610" text-anchor="middle">检查节点最后活跃时间</text>
  
  <path d="M290 1600 L650 1600" class="arrow" />
  
  <rect x="70" y="1630" width="210" height="30" class="process" />
  <text x="175" y="1650" text-anchor="middle">处理离线节点任务</text>
  
  <rect x="70" y="1670" width="210" height="40" class="process" />
  <text x="175" y="1690" text-anchor="middle">将任务重新分配给</text>
  <text x="175" y="1710" text-anchor="middle">可用节点</text>
  
  <path d="M290 1690 L400 1690" class="arrow" />
  
  <path d="M290 1650 L650 1650" class="arrow" />
  
  <!-- MQTT Broker -->
  <rect x="400" y="1500" width="150" height="270" class="broker" />
  <text x="475" y="1520" class="subtitle" text-anchor="middle">MQTT Broker</text>
  
  <rect x="420" y="1670" width="110" height="40" class="process" />
  <text x="475" y="1690" text-anchor="middle">发送任务到</text>
  <text x="475" y="1710" text-anchor="middle">新节点</text>
  
  <!-- 数据库 -->
  <rect x="650" y="1500" width="150" height="270" class="database" />
  <text x="725" y="1520" class="subtitle" text-anchor="middle">数据库</text>
  
  <rect x="670" y="1590" width="110" height="30" class="process" />
  <text x="725" y="1610" text-anchor="middle">查询节点状态</text>
  
  <rect x="670" y="1630" width="110" height="30" class="process" />
  <text x="725" y="1650" text-anchor="middle">查询运行中任务</text>
  
  <rect x="670" y="1670" width="110" height="40" class="process" />
  <text x="725" y="1690" text-anchor="middle">更新任务关联</text>
  <text x="725" y="1710" text-anchor="middle">到新节点</text>
  
  <!-- 新分析服务节点 -->
  <rect x="850" y="1500" width="200" height="270" class="analysis" />
  <text x="950" y="1520" class="subtitle" text-anchor="middle">新分析服务节点</text>
  
  <path d="M475 1700 L850 1700" class="arrow" />
  <text x="600" y="1690" class="note">9. 迁移任务到新节点</text>
  
  <rect x="870" y="1670" width="160" height="40" class="process" />
  <text x="950" y="1690" text-anchor="middle">接收迁移任务</text>
  <text x="950" y="1710" text-anchor="middle">继续执行</text>
  
  <!-- 虚线区域 - 连接断开处理 -->
  <rect x="250" y="1520" width="550" height="45" rx="10" ry="10" fill="none" stroke="#999" stroke-dasharray="10,5"/>
  <text x="525" y="1550" text-anchor="middle" class="note">节点离线处理: 基于心跳超时或连接断开事件</text>
</svg> 